{% extends "base.html" %}

{% block content %}
<h2>Dashboard - Restaurante</h2>

{% if restaurante %}
    <!-- EstadÃ­sticas del mes (movidas al principio) -->
    {% if orders_data %}
    <div style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 6px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${{ "%.2f"|format(orders_data.stats_month.total) }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Ventas del Mes</div>
            </div>
            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 6px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{ orders_data.stats_month.orders_count }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Total Pedidos</div>
            </div>
            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 6px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{ orders_data.stats_month.pending_count }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Pendientes</div>
            </div>
            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 6px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; text-align: center;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">{{ orders_data.stats_month.completed_count }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Completados</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Columna izquierda: Logo del restaurante -->
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
            <h3 style="margin-top: 0; font-size: 16px;">Mi Restaurante</h3>
            {% if restaurante.id %}
                <img src="/restaurante/photo/{{ restaurante.id }}?_={{ range(1, 10000) | random }}"
                     alt="Logo restaurante"
                     style="width: 150px; height: 150px; object-fit: cover; border-radius: 10px; border: 3px solid #FF9800; margin-bottom: 10px;"
                     onerror="this.style.display='none'; document.getElementById('logo-placeholder').style.display='flex';">
                <div id="logo-placeholder"
                     style="display: none; width: 150px; height: 150px; border-radius: 10px; background: #e0e0e0; align-items: center; justify-content: center; font-size: 64px; color: #999; border: 3px solid #FF9800; margin: 0 auto 10px;">
                    ğŸ½ï¸
                </div>
            {% endif %}

            <div style="margin-top: 10px; text-align: left; font-size: 13px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                <p style="margin: 5px 0;"><strong>Nombre:</strong><br>{{ restaurante.nombre }}</p>
                {% if restaurante.direccion %}
                    <p style="margin: 5px 0;"><strong>DirecciÃ³n:</strong><br>{{ restaurante.direccion }}</p>
                {% endif %}
                {% if restaurante.rating %}
                    <p style="margin: 5px 0;"><strong>Rating:</strong> â­ {{ "%.1f"|format(restaurante.rating) }}</p>
                {% endif %}
            </div>

            <a class="btn" href="{{ url_for('restaurant_setup') }}" style="font-size: 12px; padding: 8px 12px; margin-top: 10px; display: block;">
                âœï¸ Editar restaurante
            </a>

            <form method="POST" action="{{ url_for('update_restaurant_logo') }}" enctype="multipart/form-data" style="margin-top: 10px;" onsubmit="return handleLogoSubmit(event)">
                <label style="font-size: 12px; display: block; margin-bottom: 5px;">Actualizar Logo:</label>
                <input type="file" name="foto" accept="image/*" required style="font-size: 11px; margin-bottom: 8px;">
                <button type="submit" class="btn" id="logo-submit-btn" style="font-size: 11px; padding: 6px 10px; background: #2196F3; width: 100%;">
                    ğŸ“· Cambiar Logo
                </button>
            </form>
        </div>

        <!-- Columna derecha: InformaciÃ³n del menÃº -->
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
            <h3 style="margin-top: 0;">MenÃº del Restaurante</h3>

            {% if menu_items and menu_items|length > 0 %}
                <div style="margin-bottom: 15px;">
                    <p><strong>Total de items:</strong> {{ menu_items|length }}</p>
                </div>

                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Producto</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Precio</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Stock</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in menu_items %}
                        <tr style="border-bottom: 1px solid #eee;" id="item-row-{{ item.id }}">
                            <td style="padding: 10px;">
                                <strong>{{ item.nombre }}</strong>
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                <span style="color: #4CAF50; font-weight: bold;">${{ "%.2f"|format(item.precio) }}</span>
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                {% if item.cantidad > 0 %}
                                    <span style="color: #4CAF50;">âœ“ {{ item.cantidad }}</span>
                                {% else %}
                                    <span style="color: #f44336;">âœ— Agotado</span>
                                {% endif %}
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="deleteMenuItem('{{ item.id }}', '{{ item.nombre }}')"
                                        style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ğŸ—‘ï¸ Eliminar
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div style="background: #fff3cd; padding: 15px; border-radius: 4px; border: 1px solid #ffc107; text-align: center;">
                    <p style="margin: 0;">âš ï¸ No tienes items en el menÃº.</p>
                    <p style="margin: 10px 0 0 0; font-size: 12px;">Agrega productos para que los clientes puedan hacer pedidos.</p>
                </div>
            {% endif %}

            <div style="margin-top: 20px;">
                <a class="btn" href="{{ url_for('add_menu_items') }}" style="background: #4CAF50; color: white;">
                    â• Agregar items al menÃº
                </a>
            </div>

            <!-- SecciÃ³n de Pedidos y EstadÃ­sticas (movida aquÃ­ despuÃ©s del menÃº) -->
            {% if orders_data %}
            <div style="margin-top: 30px;">
                <!-- Ventas por dÃ­a -->
        {% if orders_data.stats_day and orders_data.stats_day|length > 0 %}
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: white; margin-bottom: 20px;">
            <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ“Š Ventas por DÃ­a</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f0f0f0;">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Fecha</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Pedidos</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">Total Ventas</th>
                    </tr>
                </thead>
                <tbody>
                {% for day in orders_data.stats_day[:7] %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">{{ day.date }}</td>
                        <td style="padding: 10px; text-align: center;">
                            <span style="background: #2196F3; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                {{ day.count }}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: right; color: #4CAF50; font-weight: bold; font-size: 16px;">
                            ${{ "%.2f"|format(day.total) }}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Lista de pedidos -->
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: white;">
            <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ›’ Todos los Pedidos del Mes</h3>
            {% if orders_data.orders and orders_data.orders|length > 0 %}
                <div style="max-height: 600px; overflow-y: auto;">
                {% for order in orders_data.orders %}
                    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: {% if order.estado == 'completado' %}#f1f8f4{% else %}#fff8e1{% endif %};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; font-size: 14px; color: #333; margin-bottom: 5px;">
                                    {% if order.nombre_cliente %}
                                        ğŸ‘¤ {{ order.nombre_cliente }} {{ order.apellido_cliente or '' }}
                                    {% else %}
                                        ğŸ“§ {{ order.cliente_email or 'Cliente sin nombre' }}
                                    {% endif %}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ğŸ“ {{ order.direccion }}
                                </div>
                                {% if order.telefono_cliente %}
                                <div style="font-size: 12px; color: #666;">
                                    ğŸ“ {{ order.telefono_cliente }}
                                </div>
                                {% endif %}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: bold; color: #4CAF50; margin-bottom: 5px;">
                                    ${{ "%.2f"|format(order.total) }}
                                </div>
                                <div style="font-size: 11px; color: #999;">
                                    ğŸ• {{ order.created_at.split('T')[0] }} {{ order.created_at.split('T')[1].split('.')[0] if 'T' in order.created_at else '' }}
                                </div>
                            </div>
                        </div>

                        <!-- Items del pedido -->
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                            <div style="font-size: 12px; font-weight: bold; color: #666; margin-bottom: 8px;">Productos:</div>
                            {% for item in order['items'] %}
                                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; padding: 4px 0; border-bottom: 1px dotted #eee;">
                                    <span>{{ item.cantidad }}x {{ item.nombre }}</span>
                                    <span style="color: #666;">${{ "%.2f"|format(item.subtotal) }}</span>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Estado y repartidor -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                {% if order.estado == 'completado' %}
                                    <span style="background: #4CAF50; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                        âœ“ ENTREGADO
                                    </span>
                                {% elif order.estado == 'asignado' %}
                                    <span style="background: #FF9800; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                        ğŸšš EN CAMINO
                                    </span>
                                {% else %}
                                    <span style="background: #f44336; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                        â± {{ order.estado.upper() }}
                                    </span>
                                {% endif %}
                            </div>
                            {% if order.repartidor_nombre %}
                                <div style="font-size: 12px; color: #666;">
                                    ğŸš´ Repartidor: <strong>{{ order.repartidor_nombre }}</strong>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“¦</div>
                    <p>No hay pedidos este mes</p>
                </div>
            {% endif %}
            </div>
            </div>
            {% else %}
            <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; margin-top: 20px;">
                <h3>ğŸ“¦ Pedidos</h3>
                <p style="color: #666; font-size: 14px;">Cargando informaciÃ³n de pedidos...</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
    let isSubmittingLogo = false;

    function handleLogoSubmit(event) {
        if (isSubmittingLogo) {
            event.preventDefault();
            return false;
        }

        const fileInput = event.target.querySelector('input[type="file"]');
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Selecciona una imagen primero');
            event.preventDefault();
            return false;
        }

        isSubmittingLogo = true;
        const submitBtn = document.getElementById('logo-submit-btn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ Subiendo...';
        }

        return true;
    }

    function deleteMenuItem(itemId, itemNombre) {
        if (!confirm(`Â¿EstÃ¡s seguro de eliminar "${itemNombre}" del menÃº?`)) {
            return;
        }

        const restaurantId = '{{ restaurante.id }}';

        fetch(`/restaurant/menu/${restaurantId}/${itemId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove row from table
                const row = document.getElementById(`item-row-${itemId}`);
                if (row) {
                    row.remove();
                }
                alert('Item eliminado correctamente');
                // Reload page to update the view
                location.reload();
            } else {
                alert('Error al eliminar el item: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el item');
        });
    }
    </script>

{% else %}
    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
        <h3>No tienes un restaurante registrado</h3>
        <p>Crea tu restaurante para comenzar a recibir pedidos.</p>
        <a class="btn" href="{{ url_for('restaurant_setup') }}" style="margin-top: 10px;">Crear Restaurante</a>
    </div>
{% endif %}

{% endblock %}
