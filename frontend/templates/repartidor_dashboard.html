{% extends "base.html" %}

{% block content %}
<h2>Dashboard - Repartidor</h2>
<p>Mes: {{ month }} / {{ year }}</p>

<div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 20px;">
  <!-- Columna izquierda: Foto del repartidor -->
  <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
    <h3 style="margin-top: 0; font-size: 16px;">Mi Perfil</h3>
    {% if session.get('user_id') %}
      <img id="repartidor-photo" 
           src="/repartidor/photo/{{ session.get('user_id') }}?_={{ range(1, 10000) | random }}" 
           alt="Mi foto" 
           style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 3px solid #4CAF50; margin-bottom: 10px;" 
           onerror="this.style.display='none'; document.getElementById('photo-placeholder').style.display='flex';">
      <div id="photo-placeholder" 
           style="display: none; width: 150px; height: 150px; border-radius: 50%; background: #e0e0e0; align-items: center; justify-content: center; font-size: 64px; color: #999; border: 3px solid #4CAF50; margin: 0 auto 10px;">
        üë§
      </div>
    {% endif %}
    
    {# Informaci√≥n del repartidor #}
    {% if repartidor %}
      <div style="margin-top: 10px; text-align: left; font-size: 13px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
        {% if repartidor.nombre %}
          <p style="margin: 5px 0;"><strong>Nombre:</strong><br>{{ repartidor.nombre }}</p>
        {% endif %}
        {% if repartidor.telefono %}
          <p style="margin: 5px 0;"><strong>Tel√©fono:</strong><br>{{ repartidor.telefono }}</p>
        {% endif %}
        {% if not repartidor.nombre or not repartidor.telefono %}
          <p style="margin: 5px 0; color: #ff9800; font-size: 11px;">‚ö†Ô∏è Completa tu perfil</p>
        {% endif %}
      </div>
    {% endif %}
    
    {# Siempre mostrar bot√≥n de actualizar perfil #}
    <a class="btn" href="{{ url_for('repartidor_setup') }}" style="font-size: 12px; padding: 8px 12px; margin-top: 10px; display: block;">
      {% if profile_complete %}‚úèÔ∏è Editar perfil{% else %}üìù Completar perfil{% endif %}
    </a>
  </div>
  
  <!-- Columna derecha: Informaci√≥n del pedido actual -->
  <div style="padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
    {% if current_order %}
      <h3 style="margin-top: 0;">Pedido actual</h3>
      <div style="background: #f9f9f9; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
        <p style="margin: 5px 0;"><strong>ID:</strong> {{ current_order.id }}</p>
        <p style="margin: 5px 0;"><strong>Estado:</strong> <span style="color: #ff9800; font-weight: bold;">{{ current_order.estado }}</span></p>
        
        {# Calcular total sumando items #}
        {% set total_pedido = namespace(value=0) %}
        {% for item in current_order['items'] %}
          {% set total_pedido.value = total_pedido.value + (item.cantidad * item.precio) %}
        {% endfor %}
        
        <p style="margin: 5px 0;"><strong>Valor total del pedido:</strong> <span style="font-size: 18px; color: #333;">${{ "%.2f"|format(total_pedido.value) }}</span></p>
        <p style="margin: 5px 0;"><strong>Tu ganancia (10%):</strong> <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">${{ "%.2f"|format(total_pedido.value * 0.10) }}</span></p>
      </div>
      
      <details style="margin-bottom: 12px;">
        <summary style="cursor: pointer; padding: 8px; background: #f0f0f0; border-radius: 4px;">Ver productos del pedido ({{ current_order['items']|length }} {% if current_order['items']|length == 1 %}producto{% else %}productos{% endif %})</summary>
        <ul style="margin-top: 8px; padding-left: 20px;">
        {% for item in current_order['items'] %}
          <li style="padding: 4px 0;">
            {{ item.nombre }} - Cantidad: {{ item.cantidad }} - Precio unitario: ${{ "%.2f"|format(item.precio) }}
            <strong style="color: #333;"> = ${{ "%.2f"|format(item.cantidad * item.precio) }}</strong>
          </li>
        {% endfor %}
        </ul>
        <div style="margin-top: 10px; padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #ddd;">
          <strong>Total: ${{ "%.2f"|format(total_pedido.value) }}</strong>
        </div>
      </details>
      
      <form method="POST" action="{{ url_for('completar_pedido_repartidor', order_id=current_order.id) }}">
        <button type="submit" class="btn" style="background:#28a745; color:white; width: 100%;">‚úì Liberar pedido entregado</button>
      </form>
    {% else %}
      <h3 style="margin-top: 0;">Pedido actual</h3>
      <div style="background: #f9f9f9; padding: 20px; border-radius: 4px; text-align: center; color: #666;">
        <p>üì¶ No tienes un pedido actual asignado.</p>
        <p style="font-size: 12px; margin-top: 8px;">Espera a que el sistema te asigne un nuevo pedido.</p>
      </div>
    {% endif %}
  </div>
</div>

<h3>Pedidos del mes</h3>

{# Calcular ganancia total de todos los pedidos del mes #}
{% set ganancia_total_mes = namespace(value=0) %}
{% for o in orders %}
  {% set total_orden = namespace(value=0) %}
  {% for item in o['items'] %}
    {% set total_orden.value = total_orden.value + (item.cantidad * item.precio) %}
  {% endfor %}
  {% set ganancia_total_mes.value = ganancia_total_mes.value + (total_orden.value * 0.10) %}
{% endfor %}

<p>Ganancia total del mes (10%): <strong style="color: #4CAF50; font-size: 18px;">${{ "%.2f"|format(ganancia_total_mes.value) }}</strong></p>

<ul>
{% for o in orders %}
  {# Calcular total de esta orden #}
  {% set total_orden = namespace(value=0) %}
  {% for item in o['items'] %}
    {% set total_orden.value = total_orden.value + (item.cantidad * item.precio) %}
  {% endfor %}
  
  <li style="margin-bottom: 15px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
    <div style="margin-bottom: 8px;">
      <strong>üìÖ {{ o.created_at }}</strong>
      <br>
      <span style="font-size: 12px; color: #666;">ID: {{ o.id }}</span>
    </div>
    <div style="margin-bottom: 8px;">
      <span style="padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-size: 12px;">{{ o.estado }}</span>
      <strong style="margin-left: 10px; color: #333; font-size: 16px;">Total: ${{ "%.2f"|format(total_orden.value) }}</strong>
      <span style="margin-left: 10px; color: #4CAF50;">Ganancia: ${{ "%.2f"|format(total_orden.value * 0.10) }}</span>
    </div>
    <details>
      <summary style="cursor: pointer; padding: 6px; background: #fff; border-radius: 4px; border: 1px solid #ddd;">Ver productos ({{ o['items']|length }})</summary>
      <ul style="margin-top: 8px; padding-left: 20px;">
      {% for item in o['items'] %}
        <li style="padding: 4px 0;">
          {{ item.nombre }} - Cantidad: {{ item.cantidad }} - Precio unitario: ${{ "%.2f"|format(item.precio) }}
          <strong style="color: #333;"> = ${{ "%.2f"|format(item.cantidad * item.precio) }}</strong>
        </li>
      {% endfor %}
      </ul>
      <div style="margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd;">
        <strong>Subtotal pedido: ${{ "%.2f"|format(total_orden.value) }}</strong>
      </div>
    </details>
  </li>
{% else %}
  <li>No se encontraron pedidos este mes.</li>
{% endfor %}
</ul>

{% endblock %}
