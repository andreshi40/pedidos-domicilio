{% extends "base.html" %}

{% block content %}
<h2>{{ restaurante.get('nombre') or restaurante.get('name') }}</h2>
<p>{{ restaurante.get('direccion','') }}</p>
<p class="muted">{{ restaurante.get('descripcion','') }}</p>

{% if session.get('last_order_id') %}
    <p><a class="btn" href="{{ url_for('order_status', order_id=session.get('last_order_id')) }}">Ver último pedido</a></p>
{% endif %}

<form method="post">
    <h3>Menú</h3>
    {% if menu %}
        <table class="menu-table">
            <thead><tr><th>Item</th><th>Precio</th><th>Cantidad</th></tr></thead>
            <tbody>
            {% for it in menu %}
                {# Determine item id and fields defensively: support dicts and plain values #}
                {% if it is mapping %}
                    {% set item_id = it.get('id') or it.get('_id') or it.get('item_id') %}
                    {% set item_nombre = it.get('nombre') or it.get('name') %}
                    {% set item_precio = it.get('precio') or it.get('price') %}
                {% else %}
                    {% set item_id = it %}
                    {% set item_nombre = it %}
                    {% set item_precio = '' %}
                {% endif %}
                <tr>
                    <td>{{ item_nombre }}</td>
                    <td>{{ item_precio }}</td>
                    <td><input type="number" name="item_{{ item_id }}" min="0" value="0"></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>El menú no está disponible.</p>
    {% endif %}

    <label for="direccion">Dirección de entrega</label>
    <input type="text" name="direccion" id="direccion" required>

    <button type="submit">Realizar pedido</button>
</form>

{% endblock %}

{% if current_order %}
    {% block order_status_inline %}
    <section class="order-inline">
        <h3>Estado del pedido (último)</h3>
        <p>
            ID: <span id="inline-order-id">{{ current_order.get('id') }}</span>
            <a class="order-link" href="{{ url_for('order_status', order_id=current_order.get('id')) }}">Ver detalle</a>
        </p>
        <p>Estado: <span id="inline-order-estado">{{ current_order.get('estado') }}</span>
            {% set estado = (current_order.get('estado') or '').lower() %}
            <span class="badge {{ estado }}">{{ (current_order.get('estado') or '').capitalize() }}</span>
        </p>
        <div id="inline-repartidor">
            {% if current_order.get('repartidor') %}
                <h4>Repartidor asignado</h4>
                <p>Nombre: {{ current_order.repartidor.get('nombre') }}</p>
                <p>Teléfono: {{ current_order.repartidor.get('telefono') }}</p>
            {% else %}
                <p>Aún no se ha asignado repartidor.</p>
            {% endif %}
        </div>
    </section>

    <script>
    // Poll the proxy endpoint to keep the inline order status updated
    (function(){
        const orderId = document.getElementById('inline-order-id').innerText.trim();
        const estadoEl = document.getElementById('inline-order-estado');
        const repContainer = document.getElementById('inline-repartidor');

        async function fetchStatus(){
            try{
                const resp = await fetch(`/api/order/${orderId}`);
                if(!resp.ok) return;
                const data = await resp.json();
                const estado = data.estado || data.status || '';
                estadoEl.innerText = estado;
                const rep = data.repartidor;
                if(rep){
                    repContainer.innerHTML = `\n                        <h4>Repartidor asignado</h4>\n                        <p>Nombre: ${rep.nombre || rep.name || ''}</p>\n                        <p>Teléfono: ${rep.telefono || ''}</p>\n                    `;
                } else {
                    repContainer.innerHTML = '<p>Aún no se ha asignado repartidor.</p>';
                }
                if(estado !== 'completado'){
                    setTimeout(fetchStatus, 3000);
                }
            }catch(e){
                setTimeout(fetchStatus, 5000);
            }
        }

        // start polling shortly after load
        setTimeout(fetchStatus, 500);
    })();
    </script>
    {% endblock %}
{% endif %}
